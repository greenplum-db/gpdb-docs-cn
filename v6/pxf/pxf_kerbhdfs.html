<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      为安全HDFS配置PXF |
    Greenplum Database Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  
</head>

<body class="x6-0 x6-0_pxf x6-0_pxf_pxf_kerbhdfs has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "greenplum.org";
    </script>

     
  <header class="header header-layout">
    <h1 class="logo">
      <a href="/">Greenplum Database Documentation</a>
    </h1>
    
    <div class="header-links js-bar-links">
      <div class="btn-menu" data-behavior="MenuMobile"></div>
      <div class="header-item"><a href="https://greenplum.org">Back to Greenplum Database</a></div>
      <div class="header-item">
        <a href="https://github.com/greenplum-db/gpdb/wiki">Wiki</a>
      </div>
      
    </div>
  </header>


    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">  Doc Index</a>
  <div class="nav-content">
    <ul>
      <li>
        <a href="/v6/homenav.html">Greenplum数据库&reg; 6.0文档</a>
      </li>
      <li><a href="/v6/pxf/overview_pxf.html" format="markdown">Greenplum平台扩展框架(PXF)</a></li>
      <li class="has_submenu">
        <a href="/v6/pxf/intro_pxf.html" format="markdown">PXF介绍</a>
        <ul>
          <li><a href="/v6/pxf/filter_push.html" format="markdown">PXF谓词下推</a></li>
          <li><a href="/v6/pxf/col_project.html" format="markdown">PXF列投影</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <span>PXF管理手册</span>
        <ul>
          <li class="has_submenu">
            <a href="/v6/pxf/instcfg_pxf.html" format="markdown">配置PXF</a>
            <ul>
              <li><a href="/v6/pxf/about_pxf_dir.html" format="markdown">PXF安装和配置目录</a></li>
              <li><a href="/v6/pxf/install_java.html" format="markdown">为PXF安装JAVA环境</a></li>
              <li><a href="/v6/pxf/init_pxf.html" format="markdown">初始化PXF</a></li>
              <li><a href="/v6/pxf/cfg_server.html" format="markdown">配置PXF服务器</a></li>
              <li class="has_submenu">
                <a href="/v6/pxf/client_instcfg.html" format="markdown">配置PXF HADOOP连接器（可选）</a>
                <ul>
                  <li>
                    <a href="/v6/pxf/pxfuserimpers.html">配置用户模拟和代理</a>
                  </li>
                  <li>
                    <a href="/v6/pxf/pxf_kerbhdfs.html" format="markdown">为安全HDFS配置PXF</a>
                  </li>
                </ul>
              </li>
              <li><a href="/v6/pxf/s3_objstore_cfg.html" format="markdown">配置Minio和S3对象存储的连接器（可选）</a> </li>
              <li><a href="/v6/pxf/objstore_cfg.html" format="markdown">配置Azure和Google云端存储的连接器（可选）</a> </li>
              <li><a href="/v6/pxf/jdbc_cfg.html" format="markdown">配置JDBC连接器（可选）</a> </li>
              <li><a href="/v6/pxf/cfghostport.html" format="markdown">配置PXF客户端主机和端口(可选)</a> </li>
            </ul>
          </lie>
          <li><a href="/v6/pxf/upgrade_pxf.html" format="markdown">升级PXF</a></li>
          <li><a href="/v6/pxf/cfginitstart_pxf.html" format="markdown">PXF的启动、停止和重启</a></li>
          <li><a href="/v6/pxf/using_pxf.html" format="markdown">授权用户访问PXF</a></li>
          <li><a href="/v6/pxf/reg_jar_depend.html" format="markdown">注册PXF的jar依赖</a></li>
          <li><a href="/v6/pxf/monitor_pxf.html" format="markdown">监控PXF</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <a href="/v6/pxf/access_hdfs.html" format="markdown">使用PXF访问hadoop</a>
        <ul>
          <li><a href="/v6/pxf/hdfs_text.html" format="markdown">读写文本数据</a></li>
          <li><a href="/v6/pxf/hdfs_avro.html" format="markdown">读取Avro数据</a></li>
          <li><a href="/v6/pxf/hdfs_json.html" format="markdown">读取JSON数据</a></li>
          <li><a href="/v6/pxf/hdfs_parquet.html" format="markdown">读写Parquet数据</a></li>
          <li><a href="/v6/pxf/hdfs_seqfile.html" format="markdown">读写SequenceFile数据</a></li>
          <li><a href="/v6/pxf/hdfs_fileasrow.html" format="markdown">将多行文本文件读入单个表行</a></li>
          <li><a href="/v6/pxf/hive_pxf.html" format="markdown">读取Hive表数据</a></li>
          <li><a href="/v6/pxf/hbase_pxf.html" format="markdown">读取HBase表数据</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <a href="/v6/pxf/access_objstore.html" format="markdown">使用PXF访问Azure，Google云端存储，Minio和S3对象存储</a>
        <ul>
          <li><a href="/v6/pxf/access_s3.html" format="markdown">About Accessing the S3 Object Store</a></li>
          <li><a href="/v6/pxf/objstore_text.html" format="markdown">读取和写入文本数据</a></li>
          <li><a href="/v6/pxf/objstore_avro.html" format="markdown">读取Avro数据</a></li>
          <li><a href="/v6/pxf/objstore_json.html" format="markdown">读取JSON数据</a></li>
          <li><a href="/v6/pxf/objstore_parquet.html" format="markdown">读写Parquet数据</a></li>
          <li><a href="/v6/pxf/objstore_seqfile.html" format="markdown">读写SequenceFile数据</a></li>
          <li><a href="/v6/pxf/objstore_fileasrow.html" format="markdown">将多行文本文件读入单个表行</a></li>
          <li><a href="/v6/pxf/read_s3_s3select.html" format="markdown">使用S3 Select从S3读取CSV和Parquet数据</a></li>
        </ul>
      </li>
      <li><a href="/v6/pxf/jdbc_pxf.html" format="markdown">使用PXF访问SQL数据库（JDBC）</a></li>
      <li><a href="/v6/pxf/troubleshooting_pxf.html" format="markdown">PXF故障排除</a></li>
      <li class="has_submenu">
        <a href="/v6/pxf/ref/pxf-ref.html" format="markdown">PXF实用程序手册</a>
        <ul>
          <li><a href="/v6/pxf/ref/pxf-cluster.html" format="markdown">pxf cluster</a></li>
          <li><a href="/v6/pxf/ref/pxf.html" format="markdown">pxf</a></li>
        </ul>
      </li>
      <!--li class="has_submenu">
        <a href="/v6/pxf/sdk/dev_overview.html" format="markdown">Using the PXF Java SDK</a>
        <ul>
          <li>
            <a href="/v6/pxf/sdk/dev_concepts.html" format="markdown">PXF Developer Concepts</a>
          </li>
          <li>
            <a href="/v6/pxf/sdk/pxfapi.html" format="markdown">Introducing the PXF API</a>
          </li>
          <li>
            <a href="/v6/pxf/sdk/build_conn.html" format="markdown">Building a Connector</a>
          </li>
          <li class="has_submenu">
            <a href="/v6/pxf/sdk/deploy_conn.html" format="markdown">Deploying a Connector</a>
            <ul>
              <li>
            <a href="/v6/pxf/sdk/deploy_profile.html" format="markdown">Deploying a Profile</a>
              </li>
            </ul>
          </li>
        </ul>
      </li-->
      <li>
         <a href="/v6/admin_guide/external/pxf-overview.html" format="dita" scope="peer">Back to the Administrator Guide</a>
      </li>
    </ul>
  </div>
</div>
<!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
        
          <h1 class="title-container" >
    为安全HDFS配置PXF
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li><a href="#prereq">&#20934;&#22791;</a></li>
<li><a href="#procedure">&#36807;&#31243;</a></li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <p>为您的HDFS文件系统启用Kerberos时，作为HDFS客户端的PXF需要principal文件和keytab文件来验证对HDFS的访问。要在安全的HDFS上读取或写入文件，必须创建和部署PXF的Kerberos主体和keytab文件，并确保Kerberos身份验证已启用并起作用。</p>

<h2 id="准备"><a id="prereq"></a>准备</h2>

<p>在你配置PXF去访问需要安全访问的HDFS文件系统之前，确保你已经做到：</p>

<ul>
<li><p>使用默认的PXF服务器配置配置了Hadoop连接器。</p></li>
<li><p>按照<a href="/v6/pxf/instcfg_pxf.html">Configuring PXF</a>章节秒速初始化、配置和启动PXF，包括PXF功能和Hadoop用户模拟功能启用</p></li>
<li><p>根据特定分发的说明为Hadoop集群启用Kerberos，并验证配置。</p></li>
<li><p>确保HDFS的配置参数<code>dfs.block.access.token.enable</code>已经被设置成了<code>true</code>。你可以在你hadoop集群的<code>hdfs-site.xml</code>配置文件中找到该配置。</p></li>
<li><p>注意每个Greenplum数据库segment主机(&lt;seghost&gt;)和Kerberos密钥分发中心(KDC) &lt;kdc-server&gt;主机的主机名或IP地址</p></li>
<li><p>注意群集所在的Kerberos &lt;realm&gt; 的名称。</p></li>
</ul>

<h2 id="过程"><a id="procedure"></a>过程</h2>

<p>按照如下流程为有安全的HDFS配置PXF。您将在Kerberos KDC服务器和Greenplum数据库segment主机上执行操作。</p>

<p><strong>登录到Kerberos KDC服务主机执行如下操作</strong>:</p>

<ol>
<li><p>使用<code>root</code>账户登录到 Kerberos KDC 服务主机。</p>
<pre class="highlight shell"><code><span class="gp">$ </span>ssh root@&lt;kdc-server&gt;
root@kdc-server<span class="err">$</span>
</code></pre></li>
<li><p>如果你的集群主机不存在配置文件的话，需要在KDC服务主机上分发<code>/etc/krb5.conf</code>配置文件到GPDB的<strong>每一个</strong>的segment节点，例如:</p>
<pre class="highlight shell"><code><span class="gp">root@kdc-server$ </span>scp /etc/krb5.conf seghost:/etc/krb5.conf
</code></pre></li>
<li><p>使用<code>kadmin.local</code>命令为GPDB的每个segment节点主机创建一个Kerberos PXF服务主体。服务主体的格式应为<code>gpadmin/&lt;seghost&gt;@&lt;realm&gt;</code>，其中&lt;seghost&gt;是segment主机系统的DNS可解析的全限定主机名(<code>hostname -f</code>命令的输出)。例如，以下命令在名为EXAMPLE.COM的Kerberos领域中为名为<code>host1.example.com，host2.example.com</code>和<code>host3.example.com</code>的主机创建PXF服务主体:</p>
<pre class="highlight shell"><code><span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"addprinc -randkey -pw changeme gpadmin/host1.example.com@EXAMPLE.COM"</span>
<span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"addprinc -randkey -pw changeme gpadmin/host2.example.com@EXAMPLE.COM"</span>
<span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"addprinc -randkey -pw changeme gpadmin/host3.example.com@EXAMPLE.COM"</span>
</code></pre></li>
<li><p>为每个Kerberos PXF服务主体生成一个密钥表文件。 将密钥表文件保存在任何方便的位置(本示例使用目录<code>/etc/security/keytabs</code>)。 您将在以后的步骤中将keytab文件部署到它们各自的Greenplum数据库segment主机。 例如：</p>
<pre class="highlight shell"><code><span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"xst -norandkey -k /etc/security/keytabs/pxf-host1.service.keytab gpadmin/host1.example.com@EXAMPLE.COM"</span>
<span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"xst -norandkey -k /etc/security/keytabs/pxf-host2.service.keytab gpadmin/host2.example.com@EXAMPLE.COM"</span>
<span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"xst -norandkey -k /etc/security/keytabs/pxf-host3.service.keytab gpadmin/host3.example.com@EXAMPLE.COM"</span>
</code></pre>

<p>根据需要重复<code>xst</code>命令用以在每个PXF服务主体上生成一个秘钥表。</p></li>
<li><p>列出principals:</p>
<pre class="highlight shell"><code><span class="gp">root@kdc-server$ </span>kadmin.local -q <span class="s2">"listprincs"</span>
</code></pre></li>
<li><p>将每个PXF服务主体的密钥表文件复制到其各自的segment主机。 例如，以下命令在<code>PXF_CONF=/usr/local/greenplum-pxf</code>时，将在步骤4中生成的每个主体复制到segment主机上的PXF默认keytab目录中</p>
<pre class="highlight shell"><code><span class="gp">root@kdc-server$ </span>scp /etc/security/keytabs/pxf-host1.service.keytab host1.example.com:/usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>scp /etc/security/keytabs/pxf-host2.service.keytab host2.example.com:/usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>scp /etc/security/keytabs/pxf-host3.service.keytab host3.example.com:/usr/local/greenplum-pxf/keytabs/pxf.service.keytab
</code></pre>

<p>Note the file system location of the keytab file on each PXF host; you will need this information for a later configuration step.</p></li>
<li><p>更改<code>pxf.service.keytab</code>文件的属主和权限。 这些文件必须仅由<code>gpadmin</code>用户拥有并可读。 例如:</p>
<pre class="highlight shell"><code><span class="gp">root@kdc-server$ </span>ssh host1.example.com chown gpadmin:gpadmin /usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>ssh host1.example.com chmod 400 /usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>ssh host2.example.com chown gpadmin:gpadmin /usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>ssh host2.example.com chmod 400 /usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>ssh host3.example.com chown gpadmin:gpadmin /usr/local/greenplum-pxf/keytabs/pxf.service.keytab
<span class="gp">root@kdc-server$ </span>ssh host3.example.com chmod 400 /usr/local/greenplum-pxf/keytabs/pxf.service.keytab
</code></pre></li>
</ol>

<p><strong>在每个GPDB的segment节点执行以下步骤</strong>:</p>

<ol>
<li><p>登录segment节点，例如:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>ssh gpadmin@&lt;seghost&gt;
</code></pre></li>
<li><p>如果在Greenplum的各个segment节点上Kerberos客户端包还没有被安装，那么首先安装他们。您必须具有超级用户权限才能安装操作系统软件包。 例如:</p>
<pre class="highlight shell"><code><span class="gp">root@seghost$ </span>rpm -qa | grep krb
<span class="gp">root@seghost$ </span>yum install krb5-libs krb5-workstation
</code></pre></li>
<li><p>打开 <code>pxf-env.sh</code>用户配置文件。例如使用vi命令打开<code>PXF_CONF=/usr/local/greenplum-pxf</code>:</p>
<pre class="highlight shell"><code><span class="gp">gpadmin@seghost$ </span>vi /usr/local/greenplum-pxf/conf/pxf-env.sh
</code></pre></li>
<li><p>更新<code>PXF_KEYTAB</code> 和 <code>PXF_PRINCIPAL</code> 配置. 指定keytab 文件 和 Kerberos principal的位置。这些设置的默认值如下所示:</p>
<pre class="highlight shell"><code><span class="nb">export </span><span class="nv">PXF_KEYTAB</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">PXF_CONF</span><span class="k">}</span><span class="s2">/keytabs/pxf.service.keytab"</span>
<span class="nb">export </span><span class="nv">PXF_PRINCIPAL</span><span class="o">=</span><span class="s2">"gpadmin/_HOST@EXAMPLE.COM"</span>
</code></pre>

<p>PXF automatically replaces <code>_HOST</code> with the FQDN of the segment host.</p></li>
<li><p>在segment上重启PXF服务:</p>
<pre class="highlight shell"><code><span class="gp">gpadmin@seghost$ </span><span class="nv">$GPHOME</span>/pxf/bin/pxf restart
</code></pre></li>
</ol>

        

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    
  </footer>
</div><!--end of container-->

</body>
</html>
