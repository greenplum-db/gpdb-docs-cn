<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      从HDFS中读取Avro数据 |
    Greenplum Database Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/gpdb-docs-cn/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/gpdb-docs-cn/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/gpdb-docs-cn/images/favicon.ico' rel='shortcut icon'>

  <script src="/gpdb-docs-cn/javascripts/all.js"></script>
  
</head>

<body class="x6-0 x6-0_pxf x6-0_pxf_hdfs_avro has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "greenplum.org";
    </script>

     
  <header class="header header-layout">
    <h1 class="logo">
      <a href="/">Greenplum Database Documentation</a>
    </h1>
    
    <div class="header-links js-bar-links">
      <div class="btn-menu" data-behavior="MenuMobile"></div>
      <div class="header-item"><a href="https://greenplum.org">Back to Greenplum Database</a></div>
      <div class="header-item">
        <a href="https://github.com/greenplum-db/gpdb/wiki">Wiki</a>
      </div>
      
    </div>
  </header>


    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">  Doc Index</a>
  <div class="nav-content">
    <ul>
      <li>
        <a href="/gpdb-docs-cn/v6/homenav.html">Greenplum数据库&reg; 6.0文档</a>
      </li>
      <li><a href="/gpdb-docs-cn/v6/pxf/overview_pxf.html" format="markdown">Greenplum平台扩展框架(PXF)</a></li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/intro_pxf.html" format="markdown">PXF介绍</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/filter_push.html" format="markdown">PXF谓词下推</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/col_project.html" format="markdown">PXF列投影</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <span>PXF管理手册</span>
        <ul>
          <li class="has_submenu">
            <a href="/gpdb-docs-cn/v6/pxf/instcfg_pxf.html" format="markdown">配置PXF</a>
            <ul>
              <li><a href="/gpdb-docs-cn/v6/pxf/about_pxf_dir.html" format="markdown">PXF安装和配置目录</a></li>
              <li><a href="/gpdb-docs-cn/v6/pxf/install_java.html" format="markdown">为PXF安装JAVA环境</a></li>
              <li><a href="/gpdb-docs-cn/v6/pxf/init_pxf.html" format="markdown">初始化PXF</a></li>
              <li><a href="/gpdb-docs-cn/v6/pxf/cfg_server.html" format="markdown">配置PXF服务器</a></li>
              <li class="has_submenu">
                <a href="/gpdb-docs-cn/v6/pxf/client_instcfg.html" format="markdown">配置PXF HADOOP连接器（可选）</a>
                <ul>
                  <li>
                    <a href="/gpdb-docs-cn/v6/pxf/pxfuserimpers.html">配置用户模拟和代理</a>
                  </li>
                  <li>
                    <a href="/gpdb-docs-cn/v6/pxf/pxf_kerbhdfs.html" format="markdown">为安全HDFS配置PXF</a>
                  </li>
                </ul>
              </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/s3_objstore_cfg.html" format="markdown">配置Minio和S3对象存储的连接器（可选）</a> </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/objstore_cfg.html" format="markdown">配置Azure和Google云端存储的连接器（可选）</a> </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/jdbc_cfg.html" format="markdown">配置JDBC连接器（可选）</a> </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/cfghostport.html" format="markdown">配置PXF客户端主机和端口(可选)</a> </li>
            </ul>
          </lie>
          <li><a href="/gpdb-docs-cn/v6/pxf/upgrade_pxf.html" format="markdown">升级PXF</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/cfginitstart_pxf.html" format="markdown">PXF的启动、停止和重启</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/using_pxf.html" format="markdown">授权用户访问PXF</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/reg_jar_depend.html" format="markdown">注册PXF的jar依赖</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/monitor_pxf.html" format="markdown">监控PXF</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/access_hdfs.html" format="markdown">使用PXF访问hadoop</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_text.html" format="markdown">读写文本数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_avro.html" format="markdown">读取Avro数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_json.html" format="markdown">读取JSON数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_parquet.html" format="markdown">读写Parquet数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_seqfile.html" format="markdown">读写SequenceFile数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_fileasrow.html" format="markdown">将多行文本文件读入单个表行</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hive_pxf.html" format="markdown">读取Hive表数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hbase_pxf.html" format="markdown">读取HBase表数据</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/access_objstore.html" format="markdown">使用PXF访问Azure，Google云端存储，Minio和S3对象存储</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/access_s3.html" format="markdown">About Accessing the S3 Object Store</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_text.html" format="markdown">读取和写入文本数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_avro.html" format="markdown">读取Avro数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_json.html" format="markdown">读取JSON数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_parquet.html" format="markdown">读写Parquet数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_seqfile.html" format="markdown">读写SequenceFile数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_fileasrow.html" format="markdown">将多行文本文件读入单个表行</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/read_s3_s3select.html" format="markdown">使用S3 Select从S3读取CSV和Parquet数据</a></li>
        </ul>
      </li>
      <li><a href="/gpdb-docs-cn/v6/pxf/jdbc_pxf.html" format="markdown">使用PXF访问SQL数据库（JDBC）</a></li>
      <li><a href="/gpdb-docs-cn/v6/pxf/troubleshooting_pxf.html" format="markdown">PXF故障排除</a></li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/ref/pxf-ref.html" format="markdown">PXF实用程序手册</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/ref/pxf-cluster.html" format="markdown">pxf cluster</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/ref/pxf.html" format="markdown">pxf</a></li>
        </ul>
      </li>
      <!--li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/sdk/dev_overview.html" format="markdown">Using the PXF Java SDK</a>
        <ul>
          <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/dev_concepts.html" format="markdown">PXF Developer Concepts</a>
          </li>
          <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/pxfapi.html" format="markdown">Introducing the PXF API</a>
          </li>
          <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/build_conn.html" format="markdown">Building a Connector</a>
          </li>
          <li class="has_submenu">
            <a href="/gpdb-docs-cn/v6/pxf/sdk/deploy_conn.html" format="markdown">Deploying a Connector</a>
            <ul>
              <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/deploy_profile.html" format="markdown">Deploying a Profile</a>
              </li>
            </ul>
          </li>
        </ul>
      </li-->
      <li>
         <a href="/gpdb-docs-cn/v6/admin_guide/external/pxf-overview.html" format="dita" scope="peer">Back to the Administrator Guide</a>
      </li>
    </ul>
  </div>
</div>
<!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
        
          <h1 class="title-container" >
    从HDFS中读取Avro数据
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li><a href="#prereq">&#20808;&#20915;&#26465;&#20214;</a></li>
<li>
<a href="#avro_work">&#20351;&#29992;Avro&#25968;&#25454;</a><ul>
<li><a href="#profile_hdfsavrodatamap">&#25968;&#25454;&#31867;&#22411;&#26144;&#23556;</a></li>
<li><a href="#topic_tr3_dpg_ts__section_m2p_ztg_ts">Avro &#27169;&#24335;&#21644;&#25968;&#25454;</a></li>
</ul>
</li>
<li><a href="#profile_cet">&#21019;&#24314;&#22806;&#37096;&#34920;</a></li>
<li>
<a href="#avro_example">&#31034;&#20363;&#65306;&#35835;&#21462;Avro&#25968;&#25454;</a><ul>
<li><a href="#topic_tr3_dpg_ts__section_m2p_ztg_ts_99">&#21019;&#24314;&#27169;&#24335;</a></li>
<li><a href="#topic_tr3_dpgspk_15g_tsdata">&#21019;&#24314;Avro&#25968;&#25454;&#25991;&#20214;(JSON)</a></li>
<li><a href="#topic_avro_querydata">&#20351;&#29992;hdfs:avro&#37197;&#32622;&#25991;&#20214;&#26597;&#35810;</a></li>
</ul>
</li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<p>使用PXF HDFS连接器读取Avro格式数据。本节描述如何使用PXF访问HDFS中的Avro数据，包括如何创建和查询引用HDFS中Avro文件的外部表。</p>

<h2 id="先决条件"><a id="prereq"></a>先决条件</h2>

<p>在尝试从HDFS读取或向HDFS写入数据之前，请确保已满足PXF Hadoop<a href="/gpdb-docs-cn/v6/pxf/access_hdfs.html#hadoop_prereq">先决条件</a>。</p>

<h2 id="使用avro数据"><a id="avro_work"></a>使用Avro数据</h2>

<p>Apache Avro是一个数据序列化框架，其中的数据都以压缩二进制格式序列化。Avro在Json中指定数据类型。 Avro格式数据具有独立的模式, 这也在Json中定义。 Avro模式及其数据完全是自描述的。</p>

<h3 id="数据类型映射"><a id="profile_hdfsavrodatamap"></a>数据类型映射</h3>

<p>Avro支持原生数据类型和复杂数据类型。</p>

<p>要在Greenplum数据库中表示Avro原生数据类型，请将数据值映射到相同类型的Greenplum列。</p>

<p>Avro支持复杂数据类型数组(array), 映射(map), 记录(record), 枚举(enumeration)以及固定长度类型(fixed type)。 将这些复杂数据类型的顶层字段映射为Greenplum数据库的 <code>TEXT</code>类型。虽然Greenplum本身并不支持这些类型，您可以创建Greenplum数据库函数或应用程序代码来提取或进一步处理这些复杂数据类型的子部件。</p>

<p>下表总结了Avro数据的外部映射规则。</p>

<p><a id="topic_oy3_qwm_ss__table_j4s_h1n_ss"></a></p>

<table><thead>
<tr>
<th>Avro数据类型</th>
<th>PXF/Greenplum 数据类型</th>
</tr>
</thead><tbody>
<tr>
<td>boolean</td>
<td>boolean</td>
</tr>
<tr>
<td>bytes</td>
<td>bytea</td>
</tr>
<tr>
<td>double</td>
<td>double</td>
</tr>
<tr>
<td>float</td>
<td>real</td>
</tr>
<tr>
<td>int</td>
<td>int or smallint</td>
</tr>
<tr>
<td>long</td>
<td>bigint</td>
</tr>
<tr>
<td>string</td>
<td>text</td>
</tr>
<tr>
<td>复杂类型: Array, Map, Record, or Enum</td>
<td>text, 并在集合项、映射的键值对和记录数据之间插入分隔符。</td>
</tr>
<tr>
<td>复杂类型: Fixed</td>
<td>bytea</td>
</tr>
<tr>
<td>并集</td>
<td>对于原始数据类型或复杂数据类型，遵循上述约定，具体取决于并集；支持Null值。</td>
</tr>
</tbody></table>

<h3 id="avro-模式和数据"><a id="topic_tr3_dpg_ts__section_m2p_ztg_ts"></a>Avro 模式和数据</h3>

<p>Avro 模式使用json定义，由上面数据类型映射部分中的原生类型和复杂类型组成。Avro 模式文件通常具有<code>.avsc</code>后缀。</p>

<p>Avro模式文件中的字段是通过对象数组定义的，每个对象都由名称和类型指定。</p>

<h2 id="创建外部表"><a id="profile_cet"></a>创建外部表</h2>

<p>使用<code>hdfs:avro</code>配置文件读取HDFS中的Avro格式数据，以下语法创建了引用该配置文件的可读外部表：</p>
<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span>
    <span class="p">(</span> <span class="o">&lt;</span><span class="k">column_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">data_type</span><span class="o">&gt;</span> <span class="p">[,</span> <span class="p">...]</span> <span class="o">|</span> <span class="k">LIKE</span> <span class="o">&lt;</span><span class="n">other_table</span><span class="o">&gt;</span> <span class="p">)</span>
<span class="k">LOCATION</span> <span class="p">(</span><span class="s1">'pxf://&lt;path-to-hdfs-file&gt;?PROFILE=hdfs:avro[&amp;&lt;custom-option&gt;=&lt;value&gt;[...]]'</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="s1">'CUSTOM'</span> <span class="p">(</span><span class="n">FORMATTER</span><span class="o">=</span><span class="s1">'pxfwritable_import'</span><span class="p">);</span>
</code></pre>

<p><a href="/gpdb-docs-cn/v6/ref_guide/sql_commands/CREATE_EXTERNAL_TABLE.html">CREATE EXTERNAL TABLE</a>命令中使用的特定关键字和值见下表中描述。</p>

<table><thead>
<tr>
<th>关键字</th>
<th>值</th>
</tr>
</thead><tbody>
<tr>
<td>&lt;path&#8209;to&#8209;hdfs&#8209;file&gt;</td>
<td>HDFS数据存储中目录或文件的绝对路径</td>
</tr>
<tr>
<td>PROFILE</td>
<td><code>PROFILE</code>关键字必须指定为<code>hdfs:avro</code>.</td>
</tr>
<tr>
<td>SERVER=&lt;server_name&gt;</td>
<td>PXF用于访问数据的命名服务器配置。可选的; 如果未指定，PXF将使用<code>default</code>服务器。</td>
</tr>
<tr>
<td>&lt;custom&#8209;option&gt;</td>
<td>&lt;custom-option&gt;描述见下方</td>
</tr>
<tr>
<td>FORMAT &lsquo;CUSTOM&rsquo;</td>
<td>在 <code>hdfs:avro</code>配置文件中使用<code>FORMAT</code> <code>&#39;CUSTOM&#39;</code> 。<code>CUSTOM</code> <code>FORMAT</code> 要求您指定为 <code>(FORMATTER=&#39;pxfwritable_import&#39;)</code>。</td>
</tr>
</tbody></table>

<p><a id="customopts"></a>
对于复杂数据类型，PXF<code>hdfs:avro</code>配置文件在集合项和值之间插入默认分隔符。您可以通过指定在<code>CREATE EXTERNAL TABLE</code>命令中指定<code>hdfs:avro</code>自定义选项来使用非默认分隔符。</p>

<p><code>hdfs:avro</code>配置文件支持以下&lt;custom-option&gt;：</p>

<table><thead>
<tr>
<th>选项关键字</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>COLLECTION_DELIM</td>
<td>当PXF将Avro复杂数据类型映射到文本列时，放置在顶层数组、映射或记录字段中的条目之间的分隔符。默认为逗号<code>,</code>字符。</td>
</tr>
<tr>
<td>MAPKEY_DELIM</td>
<td>当PXF将Avro复杂数据类型映射到文本列时，放置在映射项的键和值之间的分隔符。默认为冒号<code>:</code>字符。</td>
</tr>
<tr>
<td>RECORDKEY_DELIM</td>
<td>当PXF将Avro复杂数据类型映射到文本列时，放置在字段名称和记录条目之间的分隔符。 默认为冒号<code>:</code>字符。</td>
</tr>
</tbody></table>

<h2 id="示例：读取avro数据"><a id="avro_example"></a>示例：读取Avro数据</h2>

<p>本节中的示例将对具有以下字段名称和数据类型模式的Avro数据进行操作:</p>

<ul>
<li>id - 长整型</li>
<li>username - 字符串</li>
<li>followers - 字符串数组</li>
<li>fmap - 长整型映射</li>
<li>relationship - 枚举类型</li>
<li>address - 由街道号码(整型)、街道名称(字符串)、以及城市(字符串)组成的记录类型</li>
</ul>

<h3 id="创建模式"><a id="topic_tr3_dpg_ts__section_m2p_ztg_ts_99"></a>创建模式</h3>

<p>执行以下操作创建一个Avro模式，以表示上述模式。</p>

<ol>
<li><p>创建一个名为<code>avro_schema.avsc</code>的文件:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>vi /tmp/avro_schema.avsc
</code></pre></li>
<li><p>将以下文本复制并粘贴到<code>avro_schema.avsc</code>中：</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
</span><span class="nt">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"record"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"example_schema"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"namespace"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"com.example"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"fields"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"doc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Id of the user account"</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"username"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"doc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of the user account"</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"followers"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nt">"items"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">},</span><span class="w">
    </span><span class="nt">"doc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Users followers"</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fmap"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"map"</span><span class="p">,</span><span class="w"> </span><span class="nt">"values"</span><span class="p">:</span><span class="w"> </span><span class="s2">"long"</span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"relationship"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"enum"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"relationshipEnum"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"symbols"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"MARRIED"</span><span class="p">,</span><span class="s2">"LOVE"</span><span class="p">,</span><span class="s2">"FRIEND"</span><span class="p">,</span><span class="s2">"COLLEAGUE"</span><span class="p">,</span><span class="s2">"STRANGER"</span><span class="p">,</span><span class="s2">"ENEMY"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"address"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"record"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"addressRecord"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"int"</span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="s2">"street"</span><span class="p">,</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"string"</span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="s2">"city"</span><span class="p">,</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"string"</span><span class="p">}]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nt">"doc:"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"A basic schema for storing messages"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></li>
</ol>

<h3 id="创建avro数据文件(json)"><a id="topic_tr3_dpgspk_15g_tsdata"></a>创建Avro数据文件(JSON)</h3>

<p>执行以下步骤来创建符合上述模式的示例Avro文件。</p>

<ol>
<li><p>创建一个名为<code>pxf_avro.txt</code>的文本文件:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>vi /tmp/pxf_avro.txt
</code></pre></li>
<li><p>在<code>pxf_avro.txt</code>中输入以下数据：</p>
<pre class="highlight plaintext"><code>{"id":1, "username":"john","followers":["kate", "santosh"], "relationship": "FRIEND", "fmap": {"kate":10,"santosh":4}, "address":{"number":1, "street":"renaissance drive", "city":"san jose"}}

{"id":2, "username":"jim","followers":["john", "pam"], "relationship": "COLLEAGUE", "fmap": {"john":3,"pam":3}, "address":{"number":9, "street":"deer creek", "city":"palo alto"}}
</code></pre>

<p>示例数据使用逗号<code>,</code>分隔顶层字段，并使用冒号<code>:</code> 分隔键-值对以及记录字段和值.</p></li>
<li><p>将文本文件转换为Avro格式文件。有多种方法可以通过编程方式和通过命令行转换。在这个例子中，我们使用<a href="http://avro.apache.org/releases.html">Java Avro tools</a>。<code>avro-tools-1.8.1.jar</code> jar文件放置在当前目录中：</p>
<pre class="highlight shell"><code><span class="gp">$ </span>java -jar ./avro-tools-1.8.1.jar fromjson --schema-file /tmp/avro_schema.avsc /tmp/pxf_avro.txt &gt; /tmp/pxf_avro.avro
</code></pre>

<p>生成的Avro二进制文件被写入<code>/tmp/pxf_avro.avro</code>。</p></li>
<li><p>将生成的Avro文件复制到HDFS：</p>
<pre class="highlight shell"><code><span class="gp">$ </span>hdfs dfs -put /tmp/pxf_avro.avro /data/pxf_examples/
</code></pre></li>
</ol>

<h3 id="使用hdfs:avro配置文件查询"><a id="topic_avro_querydata"></a>使用hdfs:avro配置文件查询</h3>

<p>执行以下来创建和查询引用您在上一节添加到HDFS的<code>pxf_avro.avro</code>文件。创建表时：</p>

<ul>
<li> 使用PXF默认服务器。</li>
<li> 将顶层原生字段<code>id</code> (长整型)和<code>username</code>(字符串类型)映射到其等效的Greenplum的数据库类型(bigint和text)。</li>
<li> 将剩下的复杂类型映射为text类型</li>
<li> 使用<code>hdfs:avro</code>配置文件的自定义选项设置记录(record)、映射(map)和集合(collection)的分隔符</li>
</ul>

<ol>
<li><p>使用<code>hdfs:avro</code>配置文件从<code>pxf_avro.avro</code>文件创建可查询外部表：</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">pxf_hdfs_avro</span><span class="p">(</span><span class="n">id</span> <span class="n">bigint</span><span class="p">,</span> <span class="n">username</span> <span class="n">text</span><span class="p">,</span> <span class="n">followers</span> <span class="n">text</span><span class="p">,</span> <span class="n">fmap</span> <span class="n">text</span><span class="p">,</span> <span class="n">relationship</span> <span class="n">text</span><span class="p">,</span> <span class="n">address</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">LOCATION</span> <span class="p">(</span><span class="s1">'pxf://data/pxf_examples/pxf_avro.avro?PROFILE=hdfs:avro&amp;COLLECTION_DELIM=,&amp;MAPKEY_DELIM=:&amp;RECORDKEY_DELIM=:'</span><span class="p">)</span>
          <span class="n">FORMAT</span> <span class="s1">'CUSTOM'</span> <span class="p">(</span><span class="n">FORMATTER</span><span class="o">=</span><span class="s1">'pxfwritable_import'</span><span class="p">);</span>
</code></pre></li>
<li><p>对<code>pxf_hdfs_avro</code>表执行简单查询：</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pxf_hdfs_avro</span><span class="p">;</span>
</code></pre>
<pre class="highlight plaintext"><code> id | username |   followers    |        fmap         | relationship |                      address                      
----+----------+----------------+--------------------+--------------+---------------------------------------------------
  1 | john     | [kate,santosh] | {kate:10,santosh:4} | FRIEND       | {number:1,street:renaissance drive,city:san jose}
  2 | jim      | [john,pam]     | {pam:3,john:3}      | COLLEAGUE    | {number:9,street:deer creek,city:palo alto}
(2 rows)
</code></pre>

<p>外部表的简单查询显示了复杂数据类型的组成部分，这些组成部分由<code>CREATE EXTERNAL TABLE</code>中指定的分隔符分隔。</p></li>
<li><p>根据您的应用程序处理文本列中被分隔的部分。例如，以下命令使用Greenplum数据库内部的<code>string_to_array</code>函数将<code>followers</code>字段中的条目转换为新视图中的文本数组列。</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">followers_view</span> <span class="k">AS</span> 
<span class="k">SELECT</span> <span class="n">username</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">string_to_array</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="n">followers</span> <span class="k">FROM</span> <span class="mi">2</span> <span class="k">FOR</span> <span class="p">(</span><span class="k">char_length</span><span class="p">(</span><span class="n">followers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span> <span class="s1">','</span><span class="p">)::</span><span class="n">text</span><span class="p">[]</span> 
    <span class="k">AS</span> <span class="n">followers</span> 
  <span class="k">FROM</span> <span class="n">pxf_hdfs_avro</span><span class="p">;</span>
</code></pre></li>
<li><p>根据特定的关注者是否出现在视图中来执行查询并过滤行：</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="n">username</span><span class="p">,</span> <span class="n">address</span> <span class="k">FROM</span> <span class="n">followers_view</span> <span class="k">WHERE</span> <span class="n">followers</span> <span class="o">@&gt;</span> <span class="s1">'{john}'</span><span class="p">;</span>
</code></pre>
<pre class="highlight plaintext"><code> username |                   address                   
----------+---------------------------------------------
 jim      | {number:9,street:deer creek,city:palo alto}
</code></pre></li>
</ol>

        

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    
  </footer>
</div><!--end of container-->

</body>
</html>
