<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      读写HDFS SequenceFile数据 |
    Greenplum Database Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/gpdb-docs-cn/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/gpdb-docs-cn/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/gpdb-docs-cn/images/favicon.ico' rel='shortcut icon'>

  <script src="/gpdb-docs-cn/javascripts/all.js"></script>
  
</head>

<body class="x6-0 x6-0_pxf x6-0_pxf_hdfs_seqfile has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "greenplum.org";
    </script>

     
  <header class="header header-layout">
    <h1 class="logo">
      <a href="/">Greenplum Database Documentation</a>
    </h1>
    
    <div class="header-links js-bar-links">
      <div class="btn-menu" data-behavior="MenuMobile"></div>
      <div class="header-item"><a href="https://greenplum.org">Back to Greenplum Database</a></div>
      <div class="header-item">
        <a href="https://github.com/greenplum-db/gpdb/wiki">Wiki</a>
      </div>
      
    </div>
  </header>


    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">  Doc Index</a>
  <div class="nav-content">
    <ul>
      <li>
        <a href="/gpdb-docs-cn/v6/homenav.html">Greenplum数据库&reg; 6.0文档</a>
      </li>
      <li><a href="/gpdb-docs-cn/v6/pxf/overview_pxf.html" format="markdown">Greenplum平台扩展框架(PXF)</a></li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/intro_pxf.html" format="markdown">PXF介绍</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/filter_push.html" format="markdown">PXF谓词下推</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/col_project.html" format="markdown">PXF列投影</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <span>PXF管理手册</span>
        <ul>
          <li class="has_submenu">
            <a href="/gpdb-docs-cn/v6/pxf/instcfg_pxf.html" format="markdown">配置PXF</a>
            <ul>
              <li><a href="/gpdb-docs-cn/v6/pxf/about_pxf_dir.html" format="markdown">PXF安装和配置目录</a></li>
              <li><a href="/gpdb-docs-cn/v6/pxf/install_java.html" format="markdown">为PXF安装JAVA环境</a></li>
              <li><a href="/gpdb-docs-cn/v6/pxf/init_pxf.html" format="markdown">初始化PXF</a></li>
              <li><a href="/gpdb-docs-cn/v6/pxf/cfg_server.html" format="markdown">配置PXF服务器</a></li>
              <li class="has_submenu">
                <a href="/gpdb-docs-cn/v6/pxf/client_instcfg.html" format="markdown">配置PXF HADOOP连接器（可选）</a>
                <ul>
                  <li>
                    <a href="/gpdb-docs-cn/v6/pxf/pxfuserimpers.html">配置用户模拟和代理</a>
                  </li>
                  <li>
                    <a href="/gpdb-docs-cn/v6/pxf/pxf_kerbhdfs.html" format="markdown">为安全HDFS配置PXF</a>
                  </li>
                </ul>
              </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/s3_objstore_cfg.html" format="markdown">配置Minio和S3对象存储的连接器（可选）</a> </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/objstore_cfg.html" format="markdown">配置Azure和Google云端存储的连接器（可选）</a> </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/jdbc_cfg.html" format="markdown">配置JDBC连接器（可选）</a> </li>
              <li><a href="/gpdb-docs-cn/v6/pxf/cfghostport.html" format="markdown">配置PXF客户端主机和端口(可选)</a> </li>
            </ul>
          </lie>
          <li><a href="/gpdb-docs-cn/v6/pxf/upgrade_pxf.html" format="markdown">升级PXF</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/cfginitstart_pxf.html" format="markdown">PXF的启动、停止和重启</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/using_pxf.html" format="markdown">授权用户访问PXF</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/reg_jar_depend.html" format="markdown">注册PXF的jar依赖</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/monitor_pxf.html" format="markdown">监控PXF</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/access_hdfs.html" format="markdown">使用PXF访问hadoop</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_text.html" format="markdown">读写文本数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_avro.html" format="markdown">读取Avro数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_json.html" format="markdown">读取JSON数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_parquet.html" format="markdown">读写Parquet数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_seqfile.html" format="markdown">读写SequenceFile数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hdfs_fileasrow.html" format="markdown">将多行文本文件读入单个表行</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hive_pxf.html" format="markdown">读取Hive表数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/hbase_pxf.html" format="markdown">读取HBase表数据</a></li>
        </ul>
      </li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/access_objstore.html" format="markdown">使用PXF访问Azure，Google云端存储，Minio和S3对象存储</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/access_s3.html" format="markdown">About Accessing the S3 Object Store</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_text.html" format="markdown">读取和写入文本数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_avro.html" format="markdown">读取Avro数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_json.html" format="markdown">读取JSON数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_parquet.html" format="markdown">读写Parquet数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_seqfile.html" format="markdown">读写SequenceFile数据</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/objstore_fileasrow.html" format="markdown">将多行文本文件读入单个表行</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/read_s3_s3select.html" format="markdown">使用S3 Select从S3读取CSV和Parquet数据</a></li>
        </ul>
      </li>
      <li><a href="/gpdb-docs-cn/v6/pxf/jdbc_pxf.html" format="markdown">使用PXF访问SQL数据库（JDBC）</a></li>
      <li><a href="/gpdb-docs-cn/v6/pxf/troubleshooting_pxf.html" format="markdown">PXF故障排除</a></li>
      <li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/ref/pxf-ref.html" format="markdown">PXF实用程序手册</a>
        <ul>
          <li><a href="/gpdb-docs-cn/v6/pxf/ref/pxf-cluster.html" format="markdown">pxf cluster</a></li>
          <li><a href="/gpdb-docs-cn/v6/pxf/ref/pxf.html" format="markdown">pxf</a></li>
        </ul>
      </li>
      <!--li class="has_submenu">
        <a href="/gpdb-docs-cn/v6/pxf/sdk/dev_overview.html" format="markdown">Using the PXF Java SDK</a>
        <ul>
          <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/dev_concepts.html" format="markdown">PXF Developer Concepts</a>
          </li>
          <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/pxfapi.html" format="markdown">Introducing the PXF API</a>
          </li>
          <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/build_conn.html" format="markdown">Building a Connector</a>
          </li>
          <li class="has_submenu">
            <a href="/gpdb-docs-cn/v6/pxf/sdk/deploy_conn.html" format="markdown">Deploying a Connector</a>
            <ul>
              <li>
            <a href="/gpdb-docs-cn/v6/pxf/sdk/deploy_profile.html" format="markdown">Deploying a Profile</a>
              </li>
            </ul>
          </li>
        </ul>
      </li-->
      <li>
         <a href="/gpdb-docs-cn/v6/admin_guide/external/pxf-overview.html" format="dita" scope="peer">Back to the Administrator Guide</a>
      </li>
    </ul>
  </div>
</div>
<!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
        
          <h1 class="title-container" >
    读写HDFS SequenceFile数据
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li><a href="#prereq">&#20808;&#20915;&#26465;&#20214;</a></li>
<li><a href="#hdfswrite_writeextdata">&#21019;&#24314;&#22806;&#37096;&#34920;</a></li>
<li><a href="#write_binary">&#35835;&#20889;&#20108;&#36827;&#21046;&#25968;&#25454;</a></li>
<li>
<a href="#read_recordkey">&#35835;&#21462;&#35760;&#24405;&#38190;</a><ul><li><a href="#read_recordkey_example">&#31034;&#20363;&#65306; &#20351;&#29992;&#35760;&#24405;&#38190;</a></li></ul>
</li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<p>PXF HDFS连接器支持SequenceFile格式的二进制数据。本节描述如何使用PXF读写HDFS SequenceFile数据，包括如何创建引用HDFS文件的外部表，查询和向外部表写入数据。</p>

<h2 id="先决条件"><a id="prereq"></a>先决条件</h2>

<p>在尝试从HDFS读取或向HDFS写入数据之前，请确保已满足PXF Hadoop<a href="/gpdb-docs-cn/v6/pxf/access_hdfs.html#hadoop_prereq">先决条件</a>。</p>

<h2 id="创建外部表"><a id="hdfswrite_writeextdata"></a>创建外部表</h2>

<p>PXF HDFS连接器 <code>hdfs:SequenceFile</code> 配置文件支持读写HDFS中SequenceFile格式的二进制数据。 当您将记录插入可写外部表中时，您插入的数据块将写入指定目录中的一个或多个文件。</p>

<p><strong>注意</strong>: 使用可写配置创建的外部表仅INSERT操作。 如果要查询插入的数据，则必须单独创建一个引用相关HDFS目录的可读外部表。</p>

<p>使用以下语法创建一个引用HDFS目录的Greenplum数据库外部表：</p>
<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="p">[</span><span class="n">WRITABLE</span><span class="p">]</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span>
    <span class="p">(</span> <span class="o">&lt;</span><span class="k">column_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">data_type</span><span class="o">&gt;</span> <span class="p">[,</span> <span class="p">...]</span> <span class="o">|</span> <span class="k">LIKE</span> <span class="o">&lt;</span><span class="n">other_table</span><span class="o">&gt;</span> <span class="p">)</span>
<span class="k">LOCATION</span> <span class="p">(</span><span class="s1">'pxf://&lt;path-to-hdfs-dir&gt;
    ?PROFILE=hdfs:SequenceFile[&amp;SERVER=&lt;server_name&gt;][&amp;&lt;custom-option&gt;=&lt;value&gt;[...]]'</span><span class="p">)</span>
<span class="n">FORMAT</span> <span class="s1">'CUSTOM'</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">formatting</span><span class="o">-</span><span class="n">properties</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">[</span><span class="n">DISTRIBUTED</span> <span class="k">BY</span> <span class="p">(</span><span class="o">&lt;</span><span class="k">column_name</span><span class="o">&gt;</span> <span class="p">[,</span> <span class="p">...</span> <span class="p">]</span> <span class="p">)</span> <span class="o">|</span> <span class="n">DISTRIBUTED</span> <span class="n">RANDOMLY</span><span class="p">];</span>
</code></pre>

<p><a href="/gpdb-docs-cn/v6/ref_guide/sql_commands/CREATE_EXTERNAL_TABLE.html">CREATE EXTERNAL TABLE</a>命令中使用的特定关键字和值见下表中描述。</p>

<table><thead>
<tr>
<th>关键字</th>
<th>值</th>
</tr>
</thead><tbody>
<tr>
<td>&lt;path&#8209;to&#8209;hdfs&#8209;dir&gt;</td>
<td>HDFS数据存储中目录或文件的绝对路径</td>
</tr>
<tr>
<td>PROFILE</td>
<td><code>PROFILE</code> 关键字必须指定为 <code>hdfs:SequenceFile</code>.</td>
</tr>
<tr>
<td>SERVER=&lt;server_name&gt;</td>
<td>PXF用于访问数据的命名服务器配置。可选的; 如果未指定，PXF将使用<code>default</code>服务器。</td>
</tr>
<tr>
<td>&lt;custom&#8209;option&gt;</td>
<td>&lt;custom-option&gt; 描述见下方.</td>
</tr>
<tr>
<td>FORMAT</td>
<td>使用 <code>FORMAT</code> &rsquo;<code>CUSTOM</code>&rsquo; 时指定 <code>(FORMATTER=&#39;pxfwritable_export&#39;)</code> (写入) 或 <code>(FORMATTER=&#39;pxfwritable_import&#39;)</code> (读取).</td>
</tr>
<tr>
<td>DISTRIBUTED BY</td>
<td>如果您计划将现有Greenplum数据库表中的数据加载到可写外部表，考虑在可写外部表上使用与Greenplum表相同的分布策略或&lt;字段名&gt;。 这样做可以避免数据加载操作中segment节点间额外的数据移动。</td>
</tr>
</tbody></table>

<p><a id="customopts"></a>
SequenceFile 格式数据可以选择采用record或block压缩。 PXF <code>hdfs:SequenceFile</code> 配置支持以下压缩编解码器：</p>

<ul>
<li>org.apache.hadoop.io.compress.DefaultCodec</li>
<li>org.apache.hadoop.io.compress.BZip2Codec</li>
</ul>

<p>使用 <code>hdfs:SequenceFile</code> 配置文件写入SequenceFile格式数据时，则必须提供Java类的名称，以用于序列化/反序列化二进制数据。 这个类必须为数据模式中引用的每种数据类型提供读写方法。</p>

<p>您可以通过 <code>CREATE EXTERNAL TABLE</code> <code>LOCATION</code> 子句的自定义选项指定压缩编解码器和Java 序列化类。 <code>hdfs:SequenceFile</code> 配置文件支持以下自定义选项：</p>

<table><thead>
<tr>
<th>选项</th>
<th>值描述</th>
</tr>
</thead><tbody>
<tr>
<td>COMPRESSION_CODEC</td>
<td>压缩编码器类名称。 如果此选项未提供，Greenplum 数据库不执行数据压缩。 支持的压缩编解码器包括：<br><code>org.apache.hadoop.io.compress.DefaultCodec</code><br><code>org.apache.hadoop.io.compress.BZip2Codec</code><br><code>org.apache.hadoop.io.compress.GzipCodec</code></td>
</tr>
<tr>
<td>COMPRESSION_TYPE</td>
<td>采用的压缩类型; 支持的值有 <code>RECORD</code> (默认) 或 <code>BLOCK</code>.</td>
</tr>
<tr>
<td>DATA-SCHEMA</td>
<td>编写器序列化/反序列化类的名称。 此类所在的jar文件必须位于PXF类路径中。 <code>hdfs:SequenceFile</code> 配置文件需要此选项，并且没有默认值。</td>
</tr>
<tr>
<td>THREAD-SAFE</td>
<td>确定表查询是否可以在多线程模式下运行的布尔值。 默认为 <code>TRUE</code>。 将此选项设置为 <code>FALSE</code> 以处理单个线程中所有非线程安全操作 (例如，压缩)的请求。</td>
</tr>
</tbody></table>

<h2 id="读写二进制数据"><a id="write_binary"></a>读写二进制数据</h2>

<p>当您要读写HDFS中 SequenceFile 格式的数据，请使用HDFS 连接器 <code>hdfs:SequenceFile</code> 配置文件。 这种类型的文件由二进制键/值对组成。 SequenceFile 格式是MapReduce作业之间常见的数据传输格式。</p>

<h3 id="示例：-将二进制数据写入hdfs"><a id="write_seqfile_example" class="no-quick-link"></a>示例： 将二进制数据写入HDFS</h3>

<p>在此示例中，您将创建一个名为 <code>PxfExample_CustomWritable</code> 的Java类，该类将对先前示例中使用的示例模式中的字段进行序列化/反序列化。然后，您将使用此类访问通过<code>hdfs:SequenceFile</code>配置文件创建的可写外部表，该表使用默认的PXF服务器。</p>

<p>执行以下步骤来创建Java类和可写外部表。</p>

<ol>
<li><p>准备创建示例Java类:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>mkdir -p pxfex/com/example/pxf/hdfs/writable/dataschema
<span class="gp">$ </span><span class="nb">cd </span>pxfex/com/example/pxf/hdfs/writable/dataschema
<span class="gp">$ </span>vi PxfExample_CustomWritable.java
</code></pre></li>
<li><p>将以下文本复制并黏贴到 <code>PxfExample_CustomWritable.java</code> 文件中：</p>
<pre class="highlight java"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">pxf</span><span class="o">.</span><span class="na">hdfs</span><span class="o">.</span><span class="na">writable</span><span class="o">.</span><span class="na">dataschema</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.hadoop.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataInput</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataOutput</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>

<span class="cm">/**
* PxfExample_CustomWritable class - used to serialize and deserialize data with
* text, int, and float data types
*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PxfExample_CustomWritable</span> <span class="kd">implements</span> <span class="n">Writable</span> <span class="o">{</span>

<span class="kd">public</span> <span class="n">String</span> <span class="n">st1</span><span class="o">,</span> <span class="n">st2</span><span class="o">;</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="n">int1</span><span class="o">;</span>
<span class="kd">public</span> <span class="kt">float</span> <span class="n">ft</span><span class="o">;</span>

<span class="kd">public</span> <span class="nf">PxfExample_CustomWritable</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">st1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="n">st2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="n">int1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">ft</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">PxfExample_CustomWritable</span><span class="o">(</span><span class="kt">int</span> <span class="n">i1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i3</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">st1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"short_string___"</span> <span class="o">+</span> <span class="n">i1</span><span class="o">);</span>
    <span class="n">st2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"short_string___"</span> <span class="o">+</span> <span class="n">i1</span><span class="o">);</span>
    <span class="n">int1</span> <span class="o">=</span> <span class="n">i2</span><span class="o">;</span>
    <span class="n">ft</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">*</span> <span class="mi">10</span><span class="o">.</span><span class="na">f</span> <span class="o">*</span> <span class="mf">2.3f</span><span class="o">;</span>

<span class="o">}</span>

<span class="n">String</span> <span class="nf">GetSt1</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">st1</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">String</span> <span class="nf">GetSt2</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">st2</span><span class="o">;</span>
<span class="o">}</span>

<span class="kt">int</span> <span class="nf">GetInt1</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">int1</span><span class="o">;</span>
<span class="o">}</span>

<span class="kt">float</span> <span class="nf">GetFt</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">ft</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

    <span class="n">Text</span> <span class="n">txt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Text</span><span class="o">();</span>
    <span class="n">txt</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">st1</span><span class="o">);</span>
    <span class="n">txt</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
    <span class="n">txt</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">st2</span><span class="o">);</span>
    <span class="n">txt</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>

    <span class="n">IntWritable</span> <span class="n">intw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntWritable</span><span class="o">();</span>
    <span class="n">intw</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">int1</span><span class="o">);</span>
    <span class="n">intw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>

    <span class="n">FloatWritable</span> <span class="n">fw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FloatWritable</span><span class="o">();</span>
    <span class="n">fw</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ft</span><span class="o">);</span>
    <span class="n">fw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">readFields</span><span class="o">(</span><span class="n">DataInput</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

    <span class="n">Text</span> <span class="n">txt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Text</span><span class="o">();</span>
    <span class="n">txt</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
    <span class="n">st1</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">txt</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
    <span class="n">st2</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

    <span class="n">IntWritable</span> <span class="n">intw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntWritable</span><span class="o">();</span>
    <span class="n">intw</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
    <span class="n">int1</span> <span class="o">=</span> <span class="n">intw</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

    <span class="n">FloatWritable</span> <span class="n">fw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FloatWritable</span><span class="o">();</span>
    <span class="n">fw</span><span class="o">.</span><span class="na">readFields</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
    <span class="n">ft</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">printFieldTypes</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Class</span> <span class="n">myClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="n">Field</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">myClass</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fields</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getType</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></li>
<li><p>编译并为 <code>PxfExample_CustomWritable</code> 创建Java类JAR文件。 为您的Hadoop发行版提供一个包含 <code>hadoop-common.jar</code> 文件的类路径。 例如， 如果您安装了Hortonworks Data Platform Hadoop客户端：</p>
<pre class="highlight shell"><code><span class="gp">$ </span>javac -classpath /usr/hdp/current/hadoop-client/hadoop-common.jar  PxfExample_CustomWritable.java
<span class="gp">$ </span><span class="nb">cd</span> ../../../../../../
<span class="gp">$ </span>jar cf pxfex-customwritable.jar com
<span class="gp">$ </span>cp pxfex-customwritable.jar /tmp/
</code></pre>

<p>(您的Hadoop库类路径可能不同)</p></li>
<li><p>将 <code>pxfex-customwritable.jar</code> 文件复制到Greenplum 数据库master节点。 例如：</p>
<pre class="highlight shell"><code><span class="gp">$ </span>scp pxfex-customwritable.jar gpadmin@gpmaster:/home/gpadmin
</code></pre></li>
<li><p>登录到您的Greenplum数据库master节点：</p>
<pre class="highlight shell"><code><span class="gp">$ </span>ssh gpadmin@&lt;gpmaster&gt;
</code></pre></li>
<li><p>将 <code>pxfex-customwritable.jar</code> JAR文件复制到用户运行时类库目录中，并记下位置。 例如， 如果 <code>PXF_CONF=/usr/local/greenplum-pxf</code>：</p>
<pre class="highlight shell"><code><span class="gp">gpadmin@gpmaster$ </span>cp /home/gpadmin/pxfex-customwritable.jar /usr/local/greenplum-pxf/lib/pxfex-customwritable.jar
</code></pre></li>
<li><p>将PXF配置同步到Greenplum数据库集群。 例如：</p>
<pre class="highlight shell"><code><span class="gp">gpadmin@gpmaster$ </span><span class="nv">$GPHOME</span>/pxf/bin/pxf cluster sync
</code></pre></li>
<li><p>如<a href="/gpdb-docs-cn/v6/pxf/cfginitstart_pxf.html#restart_pxf">重启PXF</a>中所述，在每个Greenplum数据库segment主机上重启PXF。</p></li>
<li><p>使用PXF <code>hdfs:SequenceFile</code> 配置文件创建Greenplum数据库可写外部表。 在 <code>DATA-SCHEMA</code> 自定义选项 &lt;custom-option&gt; 中标识您在上面创建的序列化/反序列化Java类。 创建可写外部表时，使用 <code>BZip2</code> 压缩并指定 <code>BLOCK</code> 压缩模式。</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="n">WRITABLE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">pxf_tbl_seqfile</span> <span class="p">(</span><span class="k">location</span> <span class="n">text</span><span class="p">,</span> <span class="k">month</span> <span class="n">text</span><span class="p">,</span> <span class="n">number_of_orders</span> <span class="n">integer</span><span class="p">,</span> <span class="n">total_sales</span> <span class="n">real</span><span class="p">)</span>
            <span class="k">LOCATION</span> <span class="p">(</span><span class="s1">'pxf://data/pxf_examples/pxf_seqfile?PROFILE=hdfs:SequenceFile&amp;DATA-SCHEMA=com.example.pxf.hdfs.writable.dataschema.PxfExample_CustomWritable&amp;COMPRESSION_TYPE=BLOCK&amp;COMPRESSION_CODEC=org.apache.hadoop.io.compress.BZip2Codec'</span><span class="p">)</span>
          <span class="n">FORMAT</span> <span class="s1">'CUSTOM'</span> <span class="p">(</span><span class="n">FORMATTER</span><span class="o">=</span><span class="s1">'pxfwritable_export'</span><span class="p">);</span>
</code></pre>

<p>注意 <code>&#39;CUSTOM&#39;</code> <code>FORMAT</code> 格式化属性 &lt;formatting-properties&gt; 指定为内置的 <code>pxfwritable_export</code> 格式化程序。</p></li>
<li><p>通过直接插入 <code>pxf_tbl_seqfile</code> 表将一些数据写入 <code>pxf_seqfile</code> HDFS目录中。 例如：</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">pxf_tbl_seqfile</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="s1">'Frankfurt'</span><span class="p">,</span> <span class="s1">'Mar'</span><span class="p">,</span> <span class="mi">777</span><span class="p">,</span> <span class="mi">3956</span><span class="p">.</span><span class="mi">98</span> <span class="p">);</span>
<span class="n">postgres</span><span class="o">=#</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">pxf_tbl_seqfile</span> <span class="k">VALUES</span> <span class="p">(</span> <span class="s1">'Cleveland'</span><span class="p">,</span> <span class="s1">'Oct'</span><span class="p">,</span> <span class="mi">3812</span><span class="p">,</span> <span class="mi">96645</span><span class="p">.</span><span class="mi">37</span> <span class="p">);</span>
</code></pre></li>
<li><p>回想一下，Greenplum 数据库不支持直接查询一个可写外部表。要读取<code>pxf_seqfile</code>中的数据，请创建一个引用此HDFS目录的可读外部表：</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">read_pxf_tbl_seqfile</span> <span class="p">(</span><span class="k">location</span> <span class="n">text</span><span class="p">,</span> <span class="k">month</span> <span class="n">text</span><span class="p">,</span> <span class="n">number_of_orders</span> <span class="n">integer</span><span class="p">,</span> <span class="n">total_sales</span> <span class="n">real</span><span class="p">)</span>
            <span class="k">LOCATION</span> <span class="p">(</span><span class="s1">'pxf://data/pxf_examples/pxf_seqfile?PROFILE=hdfs:SequenceFile&amp;DATA-SCHEMA=com.example.pxf.hdfs.writable.dataschema.PxfExample_CustomWritable'</span><span class="p">)</span>
          <span class="n">FORMAT</span> <span class="s1">'CUSTOM'</span> <span class="p">(</span><span class="n">FORMATTER</span><span class="o">=</span><span class="s1">'pxfwritable_import'</span><span class="p">);</span>
</code></pre>

<p>当您通过 <code>hdfs:SequenceFile</code> 配置文件读取HDFS数据是必须指定 <code>DATA-SCHEMA</code> 自定义选项 &lt;custom-option&gt;。 您无需提供压缩相关的选项。</p></li>
<li><p>查询可读外部表 <code>read_pxf_tbl_seqfile</code>：</p>
<pre class="highlight sql"><code><span class="n">gpadmin</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">read_pxf_tbl_seqfile</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total_sales</span><span class="p">;</span>
</code></pre>
<pre class="highlight plaintext"><code> location  | month | number_of_orders | total_sales 
-----------+-------+------------------+-------------
 Frankfurt | Mar   |              777 |     3956.98
 Cleveland | Oct   |             3812 |     96645.4
(2 rows)
</code></pre></li>
</ol>

<h2 id="读取记录键"><a id="read_recordkey"></a>读取记录键</h2>

<p>当Greenplum数据库外部表引用SequenceFile或其他以键-值对存储行的数据格式时， 您可以通过使用 <code>recordkey</code> 关键字作为字段名称，在Greenplum查询中访问记录键的值。</p>

<p><code>recordkey</code> 字段类型必须与记录键类型相对应，就像其他字段必须与HDFS数据匹配一样。. </p>

<p>您可以将 <code>recordkey</code> 定义为以下任何Hadoop类型：</p>

<ul>
<li>  BooleanWritable</li>
<li>  ByteWritable</li>
<li>  DoubleWritable</li>
<li>  FloatWritable</li>
<li>  IntWritable</li>
<li>  LongWritable</li>
<li>  Text</li>
</ul>

<p>如果没有为行定义记录键， Greenplum数据库将返回处理该行的segment的id。</p>

<h3 id="示例：-使用记录键"><a id="read_recordkey_example"></a>示例： 使用记录键</h3>

<p>创建一个可读外部表，以访问您在 <a href="#write_seqfile_example">示例： 将二进制数据写入HDFS</a> 创建的可写外部表 <code>pxf_tbl_seqfile</code> 的记录键。 本例中将 <code>recordkey</code> 定义为 <code>int8</code> 类型。</p>
<pre class="highlight sql"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">read_pxf_tbl_seqfile_recordkey</span><span class="p">(</span><span class="n">recordkey</span> <span class="n">int8</span><span class="p">,</span> <span class="k">location</span> <span class="n">text</span><span class="p">,</span> <span class="k">month</span> <span class="n">text</span><span class="p">,</span> <span class="n">number_of_orders</span> <span class="n">integer</span><span class="p">,</span> <span class="n">total_sales</span> <span class="n">real</span><span class="p">)</span>
                <span class="k">LOCATION</span> <span class="p">(</span><span class="s1">'pxf://data/pxf_examples/pxf_seqfile?PROFILE=hdfs:SequenceFile&amp;DATA-SCHEMA=com.example.pxf.hdfs.writable.dataschema.PxfExample_CustomWritable'</span><span class="p">)</span>
          <span class="n">FORMAT</span> <span class="s1">'CUSTOM'</span> <span class="p">(</span><span class="n">FORMATTER</span><span class="o">=</span><span class="s1">'pxfwritable_import'</span><span class="p">);</span>
<span class="n">gpadmin</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">read_pxf_tbl_seqfile_recordkey</span><span class="p">;</span>
</code></pre>
<pre class="highlight plaintext"><code> recordkey |  location   | month | number_of_orders | total_sales 
-----------+-------------+-------+------------------+-------------
         2 | Frankfurt   | Mar   |              777 |     3956.98
         1 | Cleveland   | Oct   |             3812 |     96645.4
(2 rows)
</code></pre>

<p>当您将行插入到可写外部表时，您没有定义记录键， 因此 <code>recordkey</code> 标识为处理该行的segment。</p>

        

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    
  </footer>
</div><!--end of container-->

</body>
</html>
